THREE.Binder={bind:function(u,p){return function(t,e){e.__binds||(e.__binds=[]);var i=u;_.isArray(t)&&(i=t[0],t=t[1]);for(var n=/^([^.:]*(?:\.[^.:]+)*)?(?:\:(.*))?$/.exec(t),s=n[1].split(/\./g),r=s.pop(),a=n[2]||r,o=s.shift(),l={this:e}[o]||p[o]||u[o]||i;l&&(t=s.shift());)l=l[t];if(l&&(l.on||l.addEventListener)){function h(t){e[a]&&e[a](t,u)}THREE.Binder._polyfill(l,["addEventListener","on"],function(t){l[t](r,h)});var d={target:l,name:r,callback:h};return e.__binds.push(d),h}throw"Cannot bind '"+t+"' in "+this.__name}},unbind:function(){return function(t){t.__binds&&(t.__binds.forEach(function(e){THREE.Binder._polyfill(e.target,["removeEventListener","off"],function(t){e.target[t](e.name,e.callback)})}.bind(this)),t.__binds=[])}},apply:function(t){Object.assign(t,THREE.EventDispatcher.prototype),t.trigger=THREE.Binder._trigger,t.triggerOnce=THREE.Binder._triggerOnce,t.on=t.addEventListener,t.off=t.removeEventListener,t.dispatchEvent=t.trigger},_triggerOnce:function(t){this.trigger(t),this._listeners&&delete this._listeners[t.type]},_trigger:function(t){if(void 0!==this._listeners){var e=t.type,i=this._listeners[e];if(void 0!==i){var n=(i=i.slice()).length;t.target=this;for(var s=0;s<n;s++)i[s].call(this,t,this)}}},_polyfill:function(e,t,i){t.map(function(t){return e.method}),t.length&&i(t[0])}},THREE.Api={apply:function(t){t.set=function(t){var n=this.options||{},e=_.reduce(t,function(t,e,i){return n[i]!==e&&(t[i]=e),t},{});this.options=_.extend(n,e),this.trigger({type:"change",options:t,changes:e})},t.get=function(){return this.options},t.api=function(t,n){return t=t||{},n&&_.each(t,function(t,e,i){_.isFunction(t)&&(i[e]=_.partialRight(t,n))}),t.set=this.set.bind(this),t.get=this.get.bind(this),t}}},THREE.Bootstrap=function(t){if(t){var e=[].slice.apply(arguments);t={},e[0]instanceof Node&&(node=e[0],e=e.slice(1),t.element=node),_.isString(e[0])&&(t.plugins=e),_.isArray(e[0])&&(t.plugins=e[0]),e[0]&&(t=_.defaults(t,e[0]))}if(!(this instanceof THREE.Bootstrap))return new THREE.Bootstrap(t);var i={init:!0,element:document.body,plugins:["core"],aliases:{},plugindb:THREE.Bootstrap.Plugins||{},aliasdb:THREE.Bootstrap.Aliases||{}};this.__options=_.defaults(t||{},i),this.__inited=!1,this.__destroyed=!1,this.__installed=[];var n=this.__options.element;n===""+n&&(n=document.querySelector(n)),this.plugins={},this.element=n,this.trigger=this.trigger.bind(this),this.frame=this.frame.bind(this),this.events=["pre","update","render","post"].map(function(t){return{type:t}}),this.__options.init&&this.init()},THREE.Bootstrap.prototype={init:function(){if(!this.__inited)return this.__inited=!0,this.install(this.__options.plugins),this},destroy:function(){if(this.__inited&&!this.__destroyed)return this.__destroyed=!0,this.trigger({type:"destroy"}),this.uninstall(),this},frame:function(){this.events.map(this.trigger)},resolve:function(t){t=_.isArray(t)?t:[t];var e=this.__options,r=_.extend({},e.aliasdb,e.aliases),a=function(t){var e=t.split(":");return!e[1]||!(r[e[0]]=[e[1]])};return t=_.filter(t,a),_.each(r,function(t,e){r[e]=_.isArray(t)?t:[t]}),function i(t,n,s){if(256<=s)throw"Plug-in alias recursion detected.";return t=_.filter(t,a),_.each(t,function(t){var e=r[t];e?n=n.concat(i(e,[],s+1)):n.push(t)}),n}(t,[],0)},install:function(t){t=_.isArray(t)?t:[t],t=this.resolve(t),_.each(t,this.__install,this),this.__ready()},uninstall:function(t){t&&(t=_.isArray(t)?t:[t],t=this.resolve(t)),_.eachRight(t||this.__installed,this.__uninstall,this)},__install:function(t){var e=this.__options.plugindb[t];if(!e)throw"[three.install] Cannot install. '"+t+"' is not registered.";if(this.plugins[t])return console.warn("[three.install] "+t+" is already installed.");var i=new e(this.__options[t]||{},t);return this.plugins[t]=i,flag=i.install(this),this.__installed.push(i),this.trigger({type:"install",plugin:i}),flag},__uninstall:function(t,e){if(plugin=_.isString(t)?this.plugins[t]:t,!plugin)return console.warn("[three.uninstall] "+t+"' is not installed.");t=plugin.__name,plugin.uninstall(this),this.__installed=_.without(this.__installed,plugin),delete this.plugins[t],this.trigger({type:"uninstall",plugin:plugin})},__ready:function(){this.triggerOnce({type:"ready"})}},THREE.Binder.apply(THREE.Bootstrap.prototype),THREE.Bootstrap.Plugins={},THREE.Bootstrap.Aliases={},THREE.Bootstrap.Plugin=function(t){this.options=_.defaults(t||{},this.defaults)},THREE.Bootstrap.Plugin.prototype={listen:[],defaults:{},install:function(t){},uninstall:function(t){}},THREE.Binder.apply(THREE.Bootstrap.Plugin.prototype),THREE.Api.apply(THREE.Bootstrap.Plugin.prototype),THREE.Bootstrap.registerPlugin=function(e,t){function i(t){THREE.Bootstrap.Plugin.call(this,t),this.__name=e}i.prototype=_.extend(new THREE.Bootstrap.Plugin,t),THREE.Bootstrap.Plugins[e]=i},THREE.Bootstrap.unregisterPlugin=function(t){delete THREE.Bootstrap.Plugins[t]},THREE.Bootstrap.registerAlias=function(t,e){THREE.Bootstrap.Aliases[t]=e},THREE.Bootstrap.unregisterAlias=function(t){delete THREE.Bootstrap.Aliases[t]},THREE.Bootstrap.registerAlias("empty",["fallback","bind","renderer","size","fill","loop","time"]),THREE.Bootstrap.registerAlias("core",["empty","scene","camera","render","warmup"]),THREE.Bootstrap.registerAlias("VR",["core","cursor","fullscreen","render:vr"]),THREE.Bootstrap.registerPlugin("fallback",{defaults:{force:!1,fill:!0,begin:'<div class="threestrap-fallback" style="display: table; width: 100%; height: 100%;box-sizing: border-box; border: 1px dashed rgba(0, 0, 0, .25);"><div style="display: table-cell; padding: 10px; vertical-align: middle; text-align: center;">',end:"</div></div>",message:'<big><strong>This example requires WebGL</strong></big><br>Visit <a target="_blank" href="http://get.webgl.org/">get.webgl.org</a> for more info</a>'},install:function(e){var t;try{if(t=document.createElement("canvas"),gl=t.getContext("webgl")||t.getContext("experimental-webgl"),!gl||this.options.force)throw"WebGL unavailable.";e.fallback=!1}catch(t){var i=this.options.message,n=this.options.begin,s=this.options.end,r=this.options.fill,a=document.createElement("div");for(a.innerHTML=n+i+s,this.children=[];0<a.childNodes.length;)this.children.push(a.firstChild),e.element.appendChild(a.firstChild);return r&&e.install("fill"),this.div=a,!(e.fallback=!0)}},uninstall:function(t){this.children&&(this.children.forEach(function(t){t.parentNode.removeChild(t)}),this.children=null),delete t.fallback}}),THREE.Bootstrap.registerPlugin("renderer",{defaults:{klass:THREE.WebGLRenderer,parameters:{depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!0}},listen:["resize"],install:function(t){var e=t.renderer=new this.options.klass(this.options.parameters);t.canvas=e.domElement,t.element.appendChild(e.domElement)},uninstall:function(t){t.element.removeChild(t.renderer.domElement),delete t.renderer,delete t.canvas},resize:function(t,e){var i=e.renderer,n=i.domElement;n&&"CANVAS"==n.tagName?i.setSize(t.renderWidth,t.renderHeight,!1):(i.setRenderSize&&i.setRenderSize(t.renderWidth,t.renderHeight),i.setSize(t.viewWidth,t.viewHeight,!1))}}),THREE.Bootstrap.registerPlugin("bind",{install:function(t){var e={three:t,window:window};t.bind=THREE.Binder.bind(t,e),t.unbind=THREE.Binder.unbind(t),t.bind("install:bind",this),t.bind("uninstall:unbind",this)},uninstall:function(t){t.unbind(this),delete t.bind,delete t.unbind},bind:function(t,e){var i=t.plugin,n=i.listen;n&&n.forEach(function(t){e.bind(t,i)})},unbind:function(t,e){e.unbind(t.plugin)}}),THREE.Bootstrap.registerPlugin("size",{defaults:{width:null,height:null,aspect:null,scale:1,maxRenderWidth:1/0,maxRenderHeight:1/0,devicePixelRatio:!0},listen:["window.resize:queue","element.resize:queue","this.change:queue","ready:resize","pre:pre"],install:function(t){t.Size=this.api({renderWidth:0,renderHeight:0,viewWidth:0,viewHeight:0}),this.resized=!1},uninstall:function(t){delete t.Size},queue:function(t,e){this.resized=!0},pre:function(t,e){this.resized&&(this.resized=!1,this.resize(t,e))},resize:function(t,e){var i,n,s,r,a,o,l,h,d,u=this.options,p=e.element,c=e.renderer,g=0,f=0;l=(i=s=void 0===u.width||null==u.width?p.offsetWidth||p.innerWidth||0:u.width)/(n=r=void 0===u.height||null==u.height?p.offsetHeight||p.innerHeight||0:u.height),u.aspect&&(u.aspect>l?(n=Math.round(i/u.aspect),f=Math.floor((r-n)/2)):(i=Math.round(n*u.aspect),g=Math.floor((s-i)/2)),l=i/n),d=1,u.devicePixelRatio&&"undefined"!=typeof window&&(d=window.devicePixelRatio||1),a=Math.round(Math.min(i*d*u.scale,u.maxRenderWidth)),o=Math.round(Math.min(n*d*u.scale,u.maxRenderHeight)),raspect=a/o,raspect>l?a=Math.round(o*l):o=Math.round(a/l),d=o/n,(h=c.domElement.style).width=i+"px",h.height=n+"px",h.marginLeft=g+"px",h.marginTop=f+"px",_.extend(e.Size,{renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n,aspect:l,pixelRatio:d}),e.trigger({type:"resize",renderWidth:a,renderHeight:o,viewWidth:i,viewHeight:n,aspect:l,pixelRatio:d})}}),THREE.Bootstrap.registerPlugin("fill",{defaults:{block:!0,body:!0,layout:!0},install:function(t){this.options.body&&t.element==document.body&&(this.applied=[t.element,document.documentElement].filter(function(t){var e=t.style.height;return"auto"==e||""==e}).map(function(t){return t.style.height="100%",t.style.margin=0,t.style.padding=0,t})),this.options.block&&t.canvas&&(t.canvas.style.display="block",this.block=!0),this.options.layout&&t.element&&("static"==window.getComputedStyle(t.element).position&&(t.element.style.position="relative",this.layout=!0))},uninstall:function(t){if(this.applied){this.applied.map(function(t){return t.style.height="",t.style.margin="",t.style.padding="",t}),delete this.applied}this.block&&t.canvas&&(t.canvas.style.display="",delete this.block),this.layout&&t.element&&(t.element.style.position="",delete this.layout)},change:function(t){this.uninstall(t),this.install(t)}}),THREE.Bootstrap.registerPlugin("loop",{defaults:{start:!0,force:!0,rate:1,each:1},listen:["ready","window.resize:reset","dirty","post"],install:function(t){this.running=!1,this.pending=!1,this.lastRequestId=null,t.Loop=this.api({start:this.start.bind(this),stop:this.stop.bind(this),running:!1,window:window},t),this.frame=0},uninstall:function(t){this.stop(t)},ready:function(t,e){this.options.start&&this.start(e)},dirty:function(t,e){this.running||!this.options.force||this.pending||(this.reset(),this.start(),this.pending=!0)},post:function(t,e){this.pending=!1},reset:function(){this.frame=0},start:function(e){if(!this.running){e.Loop.running=this.running=!0;var i=e.trigger.bind(e),n=0,s=function(){if(this.running){this.lastRequestId=e.Loop.window.requestAnimationFrame(s),0==(n=(n+1)%Math.max(1,this.options.each))&&this.events.map(i);var t=this.options.rate;(t<=1||this.frame%t==0)&&e.frame(),this.frame++}}.bind(this);this.lastRequestId=e.Loop.window.requestAnimationFrame(s),e.trigger({type:"start"})}},stop:function(t){this.running&&(t.Loop.running=this.running=!1,t.Loop.window.cancelAnimationFrame(this.lastRequestId),this.lastRequestId=null,t.trigger({type:"stop"}))}}),THREE.Bootstrap.registerPlugin("time",{defaults:{speed:1,warmup:0,timeout:1},listen:["pre:tick","this.change"],now:function(){return+new Date/1e3},install:function(t){t.Time=this.api({now:this.now(),clock:0,step:1/60,frames:0,time:0,delta:1/60,average:0,fps:0}),this.last=0,this.time=0,this.clock=0,this.wait=this.options.warmup,this.clockStart=0,this.timeStart=0},tick:function(t,e){var i=this.options.speed,n=this.options.timeout,s=e.Time,r=s.now=this.now(),a=this.last,o=this.time,l=this.clock;if(a){var h=s.delta=r-a,d=s.average||h;n<h&&(h=0);var u=h*i;o+=h,l+=u,0<s.frames&&(s.average=d+.1*(h-d),s.fps=1/d),s.step=u,s.clock=l-this.clockStart,s.time=o-this.timeStart,s.frames++,0<this.wait--&&(this.clockStart=l,this.timeStart=o,s.clock=0,s.step=1e-100)}this.last=r,this.clock=l,this.time=o},uninstall:function(t){delete t.Time}}),THREE.Bootstrap.registerPlugin("scene",{install:function(t){t.scene=new THREE.Scene},uninstall:function(t){delete t.scene}}),THREE.Bootstrap.registerPlugin("camera",{defaults:{near:.01,far:1e4,type:"perspective",fov:60,aspect:null,left:-1,right:1,bottom:-1,top:1,klass:null,parameters:null},listen:["resize","this.change"],install:function(t){t.Camera=this.api(),t.camera=null,this.aspect=1,this.change({},t)},uninstall:function(t){delete t.Camera,delete t.camera},change:function(t,i){var n=this.options,e=i.camera;if(!i.camera||t.changes.type||t.changes.klass){var s=n.klass||{perspective:THREE.PerspectiveCamera,orthographic:THREE.OrthographicCamera}[n.type]||THREE.Camera;i.camera=n.parameters?new s(n.parameters):new s}_.each(n,function(t,e){i.camera.hasOwnProperty(e)&&(i.camera[e]=n[e])}.bind(this)),this.update(i),e===i.camera||i.trigger({type:"camera",camera:i.camera})},resize:function(t,e){this.aspect=t.viewWidth/Math.max(1,t.viewHeight),this.update(e)},update:function(t){t.camera.aspect=this.options.aspect||this.aspect,t.camera.updateProjectionMatrix()}}),THREE.Bootstrap.registerPlugin("render",{listen:["render"],render:function(t,e){e.scene&&e.camera&&e.renderer.render(e.scene,e.camera)}}),THREE.Bootstrap.registerPlugin("warmup",{defaults:{delay:2},listen:["ready","post"],ready:function(t,e){e.renderer.domElement.style.visibility="hidden",this.frame=0,this.hidden=!0},post:function(t,e){this.hidden&&this.frame>=this.options.delay&&(e.renderer.domElement.style.visibility="visible",this.hidden=!1),this.frame++}});